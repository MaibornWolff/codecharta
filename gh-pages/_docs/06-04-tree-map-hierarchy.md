---

permalink: /docs/tree-map-algorithm/
title: "Tree Map Algorithm"

The CodeCharta map is generated by calculating a map size first as well as placing all 2d buildings and folders as areas. Afterwards we use [three-js](https://threejs.org) to generate the 3d-models at the calculated positions.

In this document we will focus on the first part, the placement algorithm. We use [d3-hierarchy](https://github.com/d3/d3-hierarchy), a module for visualizing hierarchical data, like our code maps. The algorithm operates by placing buildings inside sub-folders and sub-folders inside their parents. All those steps ar performed in a depth-first manner all the way up to the root node.
To calculate an "optimal" packing the algorithm requires a hierarchical structure with node sizes and width and height of the root node. When receiving the data d3-hierarchy calculates a placement and allows applying margins to components.

For our visualization we apply outer-margins to have padding between folders and inner-margins for padding between the files in each folder. Furthermore, we use paddingRight to generate folder labels **below** each folder.

However, the problem with the approach is that margins are not part of the calculated map size, which leads to buildings being "compressed", e.g. a building of area 100 appearing smaller in area then a building of size 50. In some cases it even leads to buildings disappearing entirely.

The algorithm presented below aims to address the issue by calculating building areas extended by padding and providing them to the algorithm instead. This allows us to reserve more space even before paddings are applied by d3-hierarchy.

Open issues that remain are folder labels being scaled to the map size which would require two passes to address properly.

## Methods and Function

|                   Method                    | Function                                                               |
| :-----------------------------------------: | ---------------------------------------------------------------------- |
|          `getChildrenAreaValues()`          | returns all non zero area values for a given metric and hierarchy node |
|  `getSmallestValueOrSmallestDifference()`   | returns minimum between smallest difference and smallest value         |
|   `calculatePaddingBasedOnBuildingArea()`   | calculate the median building area and scale padding down              |
| `getBuildingAreasWithProportionalPadding()` | scale building area by minimum-area by delta, add scaled padding       |
|         `calculateTotalNodeArea()`          | calculate map width, height and hierarchy via d3                       |

## calculateTotalNodeArea: intermediate steps

| Steps | intermediate results                                                                                                                                                                                              |
| :---: | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `1:`  | **totalNodeArea**: sum building areas or throw an error if none exist                                                                                                                                             |
| `2:`  | generate two maps from hierarchyNode<br>**nodeKeyMap(path, node)**: maps paths to node data, helps find parent/child of node<br> **nodeAreaMap(path, 0)**: maps paths to a node area value, all set to 0 at start |
| `3:`  | **nodeAreaMap**: set file values and folder values as sum of direct children only                                                                                                                                 |
| `4:`  | **paths** : reverse nodeKeyMap(), d3-hierarchy operates depth first                                                                                                                                               |
| `5:`  | **nodeAreaMap**: add children folder areas to parent folders, root now contains total area including innerPaddings                                                                                                |
| `6:`  | calculate and apply scaling factor for each file-area per folder <br> count the amount of fodlers with floor label per hierarchy level                                                                            |
| `7:`  | hierarchyNode sum up each file in place for further calculations                                                                                                                                                  |
| `8:`  | **totalNodeArea**: add paddings areas to sum of folder areas (outerPadding), add folder label sizes                                                                                                               |
| `9:`  | **rootSide**: set root side length<br> root-folder is always a square                                                                                                                                             |
| `10:` | **factor**: check if map root is to big and set a factor to scale down if required                                                                                                                                |
| `11:` | **metricSum**: sum up all files again (overwrite), applying scaling factor to each file/folder if required                                                                                                        |
